<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Assembly Management - Online Cloud</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' font-weight='bold' fill='%231E40AF' stroke='white' stroke-width='2' font-family='Lato, sans-serif'%3EMVI%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .text-indigo-400, .text-gray-400, .text-green-400, .text-yellow-400, .text-red-400, .text-red-500, .text-teal-400, .text-teal-300, .text-purple-400, .text-purple-300, .text-lime-400 {}
        .progress-card { transition: transform 0.2s, box-shadow 0.2s; }
        .progress-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .modal { transition: opacity 0.3s ease-in-out; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } }
        .pulse-effect { animation: pulse 2s infinite; }
        .blinking-urgent { animation: blink-urgent 1s ease-in-out infinite; }
        @keyframes blink-urgent { 50% { opacity: 0.3; } }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100">

    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40 shadow-lg p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-lg font-bold text-white">MVI</div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">Assembly Pro Online</h1>
            </div>
            <div class="text-right">
                <p id="current-date-header" class="text-xs text-gray-400"></p>
                <p id="current-time-header" class="text-sm font-mono text-blue-400"></p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="dashboard-header" class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div class="flex gap-2">
                <button onclick="setFilter('All')" class="px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 hover:bg-gray-700">All</button>
                <button onclick="setFilter('Urgent')" class="px-4 py-2 rounded-lg bg-red-900/30 border border-red-800 text-red-400 hover:bg-red-800/40">Urgent</button>
            </div>
            <div class="flex gap-3">
                <button onclick="openModal('addProjectModal')" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold">+ New Assembly</button>
            </div>
        </div>

        <div id="main-grid-content" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div id="project-list-container" class="lg:col-span-1 space-y-4 max-h-[70vh] overflow-y-auto pr-2 custom-scrollbar">
                </div>
            
            <div id="detailed-project-view" class="lg:col-span-2 space-y-6">
                <div id="assembly-details-container" class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl min-h-[400px]">
                    <p class="text-gray-500 text-center mt-20 italic">Select an assembly to view details and update progress</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-xl h-96">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center p-8 text-gray-600 text-sm">
        <p id="user-info">Design By Kurniawan Didi</p>
    </footer>

    <div id="addProjectModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none modal">
        <div class="bg-gray-800 rounded-2xl border border-gray-700 w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4 text-blue-400">Create New Assembly</h2>
            <form id="projectForm" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Assembly Name</label>
                    <input type="text" id="projectName" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Total Quantity</label>
                    <input type="number" id="projectQuantity" required class="w-full bg-gray-900 border border-gray-600 rounded-lg p-2 outline-none">
                </div>
                <div class="flex items-center gap-4 py-2">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="projectUrgent" class="w-4 h-4"> <span class="text-sm">Urgent Priority</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="projectHasPallet" class="w-4 h-4"> <span class="text-sm">Add Pallet Stage</span>
                    </label>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('addProjectModal')" class="text-gray-400 px-4">Cancel</button>
                    <button type="submit" class="bg-blue-600 px-6 py-2 rounded-lg font-bold">Save to Cloud</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification-box" class="fixed top-4 right-4 p-4 rounded-lg text-white shadow-xl z-50 opacity-0 pointer-events-none transition-all duration-300"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // === MASUKKAN CONFIG FIREBASE ANDA DI SINI ===
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "project-id.firebaseapp.com",
            projectId: "project-id",
            storageBucket: "project-id.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State Global (Sesuai script asli Anda)
        let projects = [];
        let currentProjectId = null;
        let currentFilter = 'All';
        let chartInstance = null;

        // --- Sinkronisasi Cloud (Real-time) ---
        function initCloudSync() {
            onSnapshot(collection(db, "projects"), (snapshot) => {
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        }

        // --- Logika Inti (Copy dari Script ProgresRakitanV2.html Anda) ---
        
        // Simpan Data
        document.getElementById('projectForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = 'proj_' + Date.now();
            const newData = {
                name: document.getElementById('projectName').value,
                totalQuantity: parseInt(document.getElementById('projectQuantity').value),
                isUrgent: document.getElementById('projectUrgent').checked,
                hasPalletStage: document.getElementById('projectHasPallet').checked,
                rakitDone: 0, qcDone: 0, packingDone: 0, palletDone: 0,
                createdAt: new Date().toISOString()
            };
            await setDoc(doc(db, "projects", id), newData);
            closeModal('addProjectModal');
            showNotification('Project Launched!', 'success');
        };

        // Update Progress (Logika Validasi Anda tetap dijaga)
        window.updateStage = async (id, stage, amount) => {
            const project = projects.find(p => p.id === id);
            const newValue = project[stage] + amount;
            
            // Validasi (Berdasarkan script asli Anda)
            if (newValue < 0 || newValue > project.totalQuantity) return;
            if (stage === 'qcDone' && newValue > project.rakitDone) return showNotification('QC cannot exceed Assembly!', 'warning');
            if (stage === 'packingDone' && newValue > project.qcDone) return showNotification('Packing cannot exceed QC!', 'warning');

            await updateDoc(doc(db, "projects", id), { [stage]: newValue });
        };

        window.deleteProject = async (id) => {
            if (confirm('Are you sure?')) {
                await deleteDoc(doc(db, "projects", id));
                if (currentProjectId === id) currentProjectId = null;
            }
        };

        // --- Fungsi Visual ---
        function renderUI() {
            const list = document.getElementById('project-list-container');
            list.innerHTML = '';
            
            const filtered = currentFilter === 'Urgent' ? projects.filter(p => p.isUrgent) : projects;

            filtered.forEach(p => {
                const perc = ((p.packingDone / p.totalQuantity) * 100).toFixed(0);
                const activeClass = p.id === currentProjectId ? 'ring-2 ring-blue-500' : 'border-gray-700';
                list.innerHTML += `
                    <div onclick="selectProject('${p.id}')" class="bg-gray-800 p-4 rounded-xl border-2 ${activeClass} cursor-pointer hover:bg-gray-750 transition-all ${p.isUrgent ? 'border-l-4 border-l-red-500' : ''}">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold truncate">${p.name}</span>
                            <span class="text-xs font-mono text-blue-400">${perc}%</span>
                        </div>
                        <div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden">
                            <div class="bg-blue-500 h-full" style="width: ${perc}%"></div>
                        </div>
                    </div>
                `;
            });

            if (currentProjectId) {
                const active = projects.find(p => p.id === currentProjectId);
                if (active) renderDetail(active);
            }
        }

        function renderDetail(p) {
            const container = document.getElementById('assembly-details-container');
            const stages = ['rakitDone', 'qcDone', 'packingDone'];
            if (p.hasPalletStage) stages.push('palletDone');

            container.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-white">${p.name}</h2>
                        <span class="text-xs text-gray-500 uppercase tracking-widest">Quantity: ${p.totalQuantity} Units</span>
                    </div>
                    <button onclick="deleteProject('${p.id}')" class="text-gray-500 hover:text-red-500 transition-colors">Delete</button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    ${stages.map(s => `
                        <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                            <div class="flex justify-between text-sm mb-2">
                                <span class="capitalize text-gray-400">${s.replace('Done','')}</span>
                                <span class="font-mono text-blue-400">${p[s]} / ${p.totalQuantity}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 bg-gray-700 h-2 rounded-full overflow-hidden">
                                    <div class="bg-green-500 h-full transition-all" style="width: ${(p[s]/p.totalQuantity)*100}%"></div>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="updateStage('${p.id}', '${s}', -1)" class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded border border-gray-600">-</button>
                                    <button onclick="updateStage('${p.id}', '${s}', 1)" class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded">+</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            updateChart(p);
        }

        // --- Chart & Helper ---
        function updateChart(p) {
            const ctx = document.getElementById('productionChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Assemble', 'QC', 'Packing', 'Pallet'],
                    datasets: [{
                        label: 'Units',
                        data: [p.rakitDone, p.qcDone, p.packingDone, p.palletDone || 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: p.totalQuantity } } }
            });
        }

        window.selectProject = (id) => { currentProjectId = id; renderUI(); };
        window.setFilter = (f) => { currentFilter = f; renderUI(); };
        window.openModal = (id) => { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); };
        window.closeModal = (id) => { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); };
        
        function showNotification(m, t) {
            const b = document.getElementById('notification-box');
            b.textContent = m;
            b.className = `fixed top-4 right-4 p-4 rounded-lg text-white shadow-xl z-50 transition-all ${t==='success'?'bg-green-600':'bg-red-600'}`;
            b.classList.remove('opacity-0');
            setTimeout(() => b.classList.add('opacity-0'), 3000);
        }

        setInterval(() => {
            const now = new Date();
            document.getElementById('current-date-header').textContent = now.toDateString();
            document.getElementById('current-time-header').textContent = now.toLocaleTimeString();
        }, 1000);

        // Start
        initCloudSync();
    </script>
</body>
</html>
