<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microvision Production Management</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='60' font-weight='bold' fill='%234F46E5' stroke='white' stroke-width='2' font-family='sans-serif'%3EMVI%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Classes for dynamic injection */
        .text-indigo-400, .text-gray-400, .text-green-400, .text-yellow-400, .text-red-400, .text-red-500, .text-teal-400, .text-purple-400, .text-lime-400 {}
        .bg-blue-600, .bg-green-600, .bg-orange-600, .bg-purple-600, .bg-red-600, .bg-yellow-500, .bg-teal-600 {}
        .bg-blue-500, .bg-green-500, .bg-orange-500, .bg-purple-500 {}
        
        .progress-card { transition: transform 0.2s, box-shadow 0.2s; }
        .progress-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .modal { transition: opacity 0.3s ease-in-out; }
        
        @keyframes blink-urgent { 50% { opacity: 0.5; } }
        .blinking-urgent { animation: blink-urgent 1s ease-in-out infinite; }
        
        /* Loader Style */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Progress Bar Background Animation */
        .progress-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-gray-900 min-h-screen text-gray-100 flex flex-col">

    <div id="global-loader" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-[100] hidden">
        <div class="loader mb-4"></div>
        <p class="text-indigo-300 font-semibold animate-pulse">Syncing with Cloud Database...</p>
    </div>

    <header class="bg-gray-800 border-b border-indigo-500/30 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="bg-indigo-600 p-2 rounded-lg shadow-inner">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-wide leading-none">MICROVISION <span class="text-indigo-400 text-sm font-normal ml-1">v2.0</span></h1>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest mt-1">Production Assembly Control</p>
                    </div>
                </div>

                <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 justify-end">
                    <div class="flex bg-gray-700/50 rounded-lg p-1 mr-2 border border-gray-600">
                        <button onclick="loadData()" title="Force Refresh" class="p-2 text-gray-300 hover:text-white hover:bg-gray-600 rounded-md transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        </button>
                        <button id="btnDownloadImage" title="Screenshot Dashboard" class="p-2 text-gray-300 hover:text-white hover:bg-gray-600 rounded-md transition">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        </button>
                    </div>
                    <button id="btnAddProject" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg hover:shadow-indigo-500/30 transition transform hover:-translate-y-0.5 whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span>New Project</span>
                    </button>
                    <button id="btnDeleteAll" title="Reset All Data" class="ml-2 bg-red-900/30 hover:bg-red-600 text-red-200 hover:text-white p-2 rounded-lg transition border border-red-900/50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 pb-8 flex-grow">
        
        <div id="dashboard-header-container" class="mb-6 hidden">
             <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-wrap justify-between items-center border border-gray-700">
                <div class="flex items-center gap-4">
                    <div class="text-sm">
                        <span class="text-gray-400">Total Output:</span>
                        <span id="header-total-output" class="text-xl font-bold text-white ml-1">0</span>
                        <span id="header-total-target" class="text-gray-500 text-xs"> / 0</span>
                    </div>
                    <div class="h-8 w-px bg-gray-600"></div>
                    <div class="text-sm">
                        <span class="text-gray-400">Efficiency:</span>
                        <span id="header-efficiency" class="text-xl font-bold text-lime-400 ml-1">0.0%</span>
                    </div>
                </div>
                
                <div class="flex items-center mt-2 sm:mt-0">
                    <select onchange="window.setFilter(this.value)" class="bg-gray-700 text-sm rounded border border-gray-600 p-1 focus:ring-indigo-500 text-white">
                        <option value="All">All Status</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Urgent">Urgent Only</option>
                    </select>
                    <div class="ml-4 text-xs text-indigo-300 font-mono" id="live-clock">--:--</div>
                </div>
            </div>
        </div>

        <div id="notification-box" class="opacity-0 pointer-events-none fixed top-20 right-4 p-4 rounded-lg text-white shadow-xl z-50 transition-all duration-300"></div>

        <div id="main-grid-content" class="grid grid-cols-1 lg:grid-cols-[320px_1fr] gap-6 hidden">
            
            <div id="project-list-container" class="lg:sticky lg:top-24 lg:self-start flex flex-col gap-4">
                 </div>

            <div id="detailed-project-view" class="space-y-6 hidden pt-6 lg:pt-0 border-t border-gray-700 lg:border-t-0">
                
                <div id="assembly-details-container" class="bg-gray-800 p-4 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-lg min-h-[400px]">
                    <canvas id="progressChart"></canvas>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-100 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                        Control Panel
                    </h2>
                    <div id="progress-cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        </div>
                </div>

                <div id="global-history-container" class="mt-6">
                    </div>

            </div>
        </div>

        <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-20 w-20 mb-4 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
            <p class="text-xl font-semibold">No active assemblies</p>
            <p class="text-sm">Click "New Project" to start tracking production.</p>
        </div>
    </div>

    <div id="addProjectModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg border border-gray-700">
            <div class="p-6 border-b flex justify-between items-center border-gray-700">
                <h2 class="text-2xl font-bold text-gray-100">Add New Assembly</h2>
                <button onclick="closeModal('addProjectModal')" class="text-gray-400 hover:text-white">✕</button>
            </div>
            <form id="projectForm" class="p-6 space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-300">Assembly Name</label>
                    <input type="text" id="projectName" required class="mt-1 block w-full p-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Total Quantity (Target)</label>
                    <input type="number" id="projectQuantity" required min="1" class="mt-1 block w-full p-3 border border-gray-600 bg-gray-700 text-gray-100 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>
                <div class="space-y-4">
                    <div class="flex items-center">
                        <input id="projectHasPallet" type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                        <label for="projectHasPallet" class="ml-3 block text-sm font-medium text-gray-300">Include "Packing Pallet" Stage</label>
                    </div>
                    <div class="flex items-center">
                        <input id="projectUrgent" type="checkbox" class="h-5 w-5 rounded border-gray-500 bg-gray-700 text-indigo-600 focus:ring-indigo-500">
                        <label for="projectUrgent" class="ml-3 block text-sm font-medium text-gray-300">Mark as "Urgent"</label>
                    </div>
                    <div id="urgent-options" class="hidden pl-8 space-y-3 pt-2">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-xs text-gray-400">Target Date</label><input type="date" id="projectTargetDate" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded text-sm"></div>
                            <div><label class="block text-xs text-gray-400">Target Time</label><input type="time" id="projectTargetTime" class="mt-1 w-full p-2 bg-gray-700 border border-gray-600 rounded text-sm"></div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">Save Assembly</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editProjectModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl w-full max-w-lg border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between"><h2 class="text-xl font-bold text-gray-100">Edit Assembly</h2><button onclick="closeModal('editProjectModal')" class="text-gray-400">✕</button></div>
            <form id="editProjectForm" class="p-6 space-y-4">
                <input type="text" id="editProjectName" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <input type="number" id="editProjectQuantity" required class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                <div class="flex items-center"><input id="editProjectHasPallet" type="checkbox" class="w-5 h-5"><label for="editProjectHasPallet" class="ml-2 text-gray-300">Pallet Stage</label></div>
                <div class="flex items-center"><input id="editProjectUrgent" type="checkbox" class="w-5 h-5"><label for="editProjectUrgent" class="ml-2 text-gray-300">Urgent</label></div>
                <div id="edit-urgent-options" class="hidden grid grid-cols-2 gap-4">
                    <input type="date" id="editProjectTargetDate" class="p-2 bg-gray-700 rounded text-white"><input type="time" id="editProjectTargetTime" class="p-2 bg-gray-700 rounded text-white">
                </div>
                <button type="submit" class="w-full bg-indigo-600 py-3 rounded-lg font-bold text-white">Update</button>
            </form>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl max-w-sm w-full border border-red-900/50">
            <h3 class="text-xl font-bold text-red-500 mb-2">Confirm Deletion</h3>
            <p id="deleteConfirmText" class="text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('deleteConfirmModal')" class="px-4 py-2 bg-gray-700 rounded-lg text-white">Cancel</button>
                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white rounded-lg">Delete</button>
            </div>
        </div>
    </div>

    <div id="deleteAllConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl max-w-sm w-full border border-red-900/50">
            <h3 class="text-xl font-bold text-red-500 mb-2">RESET DATABASE</h3>
            <p class="text-gray-300 mb-6">This will delete ALL projects and history. Irreversible.</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('deleteAllConfirmModal')" class="px-4 py-2 bg-gray-700 rounded-lg text-white">Cancel</button>
                <button id="confirmDeleteAllButton" class="px-4 py-2 bg-red-600 text-white rounded-lg">Wipe Data</button>
            </div>
        </div>
    </div>

    <div id="manualInputModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-gray-800 p-6 rounded-xl w-80">
            <h3 id="manualInputModalTitle" class="text-lg font-bold mb-4 text-white">Update Progress</h3>
            <form id="manualInputForm" class="space-y-4">
                <input type="number" id="manualProgressValue" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 text-white">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('manualInputModal')" class="px-4 py-2 bg-gray-600 rounded text-white">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 rounded text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="manualPalletInputModal" class="modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-gray-800 p-6 rounded-xl w-80">
            <h3 class="text-lg font-bold mb-4 text-purple-400">Update Pallets</h3>
            <form id="manualPalletForm" class="space-y-4">
                <input type="number" id="manualPalletValue" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="Number of Pallets">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('manualPalletInputModal')" class="px-4 py-2 bg-gray-600 rounded text-white">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 rounded text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURATION ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbxT_u_sOmyvHj653yG8S3_v_E081e_4l_4O2v3_H8r2_Xw1_c1_2_s2_0/exec'; 
        // NOTE: PASTIKAN API_URL DI ATAS SUDAH BENAR SESUAI MILIK ANDA
        
        // --- STATE ---
        let projects = [];
        let globalHistory = [];
        let currentProjectId = null;
        let chartInstance = null;
        let currentFilter = 'All';
        let countdownInterval = null;

        // --- CORE FUNCTIONS (API) ---

        function showLoading(show) {
            const loader = document.getElementById('global-loader');
            if(show) loader.classList.remove('hidden');
            else loader.classList.add('hidden');
        }

        function loadData() {
            showLoading(true);
            const fetchUrl = `${API_URL}?action=read&t=${new Date().getTime()}`;

            fetch(fetchUrl)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    projects = data.projects || [];
                    globalHistory = data.history || [];
                    
                    projects.sort((a, b) => {
                        const getPrio = (p) => {
                            const done = p.hasPalletStage ? p.palletDone : p.packingDone;
                            const isComp = done === p.totalQuantity && p.totalQuantity > 0;
                            if (p.isUrgent) return isComp ? 2 : 1;
                            return isComp ? 3 : 4;
                        };
                        const pA = getPrio(a), pB = getPrio(b);
                        if (pA !== pB) return pA - pB;
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    });

                    if (currentProjectId && !projects.find(p => p.id === currentProjectId)) {
                        currentProjectId = null;
                    }

                    renderApp();
                    showNotification('Data synced with cloud', 'success');
                } else {
                    showNotification('Database Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error("Fetch error:", error);
                showNotification('Connection Failed. Check internet or API URL.', 'error');
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function syncData() {
            const notif = document.getElementById('notification-box');
            notif.textContent = "Saving...";
            notif.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-500', 'bg-green-500');
            notif.classList.add('bg-blue-600', 'opacity-100');

            const payload = {
                projects: projects,
                globalHistory: globalHistory
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(() => {
                setTimeout(() => showNotification('Changes Saved!', 'success'), 500);
            })
            .catch(err => {
                showNotification('Save Failed!', 'error');
                console.error(err);
            });
        }

        function addHistoryLog(type, message, details = {}) {
            const newLog = {
                type, message, timestamp: new Date().toISOString(), ...details
            };
            globalHistory.unshift(newLog);
            if (globalHistory.length > 100) globalHistory.pop();
        }

        // --- APP LOGIC ---

        function initApp() {
            startLiveClock(); // Clock is strictly DOM based now, safe to start immediately
            loadData();
            
            // Event Listeners
            document.getElementById('btnAddProject').onclick = () => openModal('addProjectModal');
            document.getElementById('btnDeleteAll').onclick = () => openModal('deleteAllConfirmModal');
            document.getElementById('projectForm').onsubmit = handleAddProject;
            document.getElementById('confirmDeleteButton').onclick = handleDeleteConfirmed;
            document.getElementById('confirmDeleteAllButton').onclick = handleDeleteAllConfirmed;
            document.getElementById('btnDownloadImage').onclick = downloadDashboard;
            
            document.getElementById('projectUrgent').onchange = (e) => 
                document.getElementById('urgent-options').classList.toggle('hidden', !e.target.checked);
            document.getElementById('editProjectUrgent').onchange = (e) => 
                document.getElementById('edit-urgent-options').classList.toggle('hidden', !e.target.checked);
                
            document.getElementById('editProjectForm').onsubmit = handleEditSubmit;
        }

        // --- ACTIONS ---

        function handleAddProject(e) {
            e.preventDefault();
            const name = document.getElementById('projectName').value;
            const qty = parseInt(document.getElementById('projectQuantity').value);
            const urgent = document.getElementById('projectUrgent').checked;
            const pallet = document.getElementById('projectHasPallet').checked;
            
            const newProj = {
                id: 'p_' + Date.now(),
                name: name,
                totalQuantity: qty,
                isUrgent: urgent,
                hasPalletStage: pallet,
                targetDate: document.getElementById('projectTargetDate').value,
                targetTime: document.getElementById('projectTargetTime').value,
                rakitDone: 0, qcDone: 0, packingDone: 0, palletDone: 0,
                createdAt: new Date().toISOString()
            };

            projects.push(newProj);
            addHistoryLog('CREATE', `Created "${name}"`);
            syncData();
            
            currentProjectId = newProj.id;
            closeModal('addProjectModal');
            e.target.reset();
            renderApp();
        }

        function handleDeleteConfirmed() {
            const p = projects.find(x => x.id === currentProjectId);
            if(p) {
                addHistoryLog('DELETE', `Deleted "${p.name}"`);
                projects = projects.filter(x => x.id !== currentProjectId);
                currentProjectId = null;
                syncData();
                renderApp();
            }
            closeModal('deleteConfirmModal');
        }

        function handleDeleteAllConfirmed() {
            projects = [];
            globalHistory = [];
            currentProjectId = null;
            syncData();
            renderApp();
            closeModal('deleteAllConfirmModal');
        }

        window.updateProgress = (stage, change) => {
            if (!currentProjectId) return;
            const pIndex = projects.findIndex(x => x.id === currentProjectId);
            if (pIndex === -1) return;
            
            const p = projects[pIndex];
            const oldVal = p[`${stage}Done`];
            const newVal = oldVal + change;

            if (newVal < 0) return showNotification('Cannot be less than 0', 'error');
            
            if (stage === 'rakit' && newVal > p.totalQuantity) return showNotification('Exceeds Total', 'error');
            if (stage === 'qc' && newVal > p.rakitDone) return showNotification('Wait for Assembly', 'error');
            if (stage === 'packing' && newVal > p.qcDone) return showNotification('Wait for QC', 'error');
            if (stage === 'pallet' && newVal > p.packingDone) return showNotification('Wait for Packing', 'error');

            if (change < 0) {
                 const prevStage = stage === 'rakit' ? 'qc' : stage === 'qc' ? 'packing' : 'pallet';
                 if (stage !== 'pallet' && p[`${prevStage}Done`] > newVal) {
                     return showNotification('Reduce next stage first', 'error');
                 }
            }

            p[`${stage}Done`] = newVal;
            addHistoryLog('PROGRESS', `${stage.toUpperCase()} for "${p.name}": ${oldVal} -> ${newVal}`);
            syncData();
            renderApp();
        };
        
        window.handlePalletAction = (isInc) => {
            const p = projects.find(x => x.id === currentProjectId);
            if(!p) return;
            
            if (isInc) {
                const remainingWrapped = p.packingDone - p.palletDone;
                const needed = (p.totalQuantity % 2 !== 0 && p.palletDone + 1 === p.totalQuantity) ? 1 : 2;
                
                if (remainingWrapped >= needed) updateProgress('pallet', needed);
                else showNotification('Not enough items wrapped', 'error');
            } else {
                if (p.palletDone <= 0) return;
                const toRemove = (p.totalQuantity % 2 !== 0 && p.palletDone === p.totalQuantity) ? 1 : 2;
                updateProgress('pallet', -toRemove);
            }
        };

        // --- RENDERING ---

        function renderApp() {
            const grid = document.getElementById('main-grid-content');
            const empty = document.getElementById('empty-state');
            const headerContainer = document.getElementById('dashboard-header-container');
            const list = document.getElementById('project-list-container');
            const details = document.getElementById('detailed-project-view');

            const filtered = projects.filter(p => {
                if(currentFilter === 'All') return true;
                const status = getStatus(p).text;
                return status === currentFilter;
            });

            if (projects.length === 0) {
                grid.classList.add('hidden');
                headerContainer.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            headerContainer.classList.remove('hidden');
            empty.classList.add('hidden');

            renderHeaderStats(projects); // ONLY UPDATE NUMBERS

            list.innerHTML = filtered.map(p => {
                const s = getStatus(p);
                const activeClass = p.id === currentProjectId ? 'ring-2 ring-indigo-500 border-indigo-500 bg-gray-700' : 'bg-gray-800 border-gray-700 hover:bg-gray-700';
                return `
                    <div onclick="selectProject('${p.id}')" class="cursor-pointer p-4 rounded-xl border shadow-md transition ${activeClass}">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-sm truncate w-32 text-gray-100">${p.name}</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded-full ${s.bg} ${s.text}">${s.text}</span>
                        </div>
                        ${p.isUrgent ? '<span class="text-[10px] text-red-500 font-bold blinking-urgent">URGENT</span>' : ''}
                        <div class="mt-2 text-xs text-gray-400 flex justify-between">
                            <span>Target: ${p.totalQuantity}</span>
                            <span>${Math.round((p.hasPalletStage ? p.palletDone : p.packingDone)/p.totalQuantity*100)}%</span>
                        </div>
                        <div class="w-full bg-gray-600 h-1 mt-1 rounded-full overflow-hidden">
                             <div class="bg-${s.color}-500 h-full" style="width: ${(p.rakitDone/p.totalQuantity)*100}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            if (currentProjectId) {
                const p = projects.find(x => x.id === currentProjectId);
                if (p) {
                    details.classList.remove('hidden');
                    renderDetails(p);
                    renderChart(p);
                    renderCards(p);
                    renderHistory();
                } else {
                     details.classList.add('hidden');
                }
            } else {
                details.classList.add('hidden');
            }
        }

        function renderHeaderStats(allProjs) {
             const total = allProjs.reduce((a, b) => a + b.totalQuantity, 0);
             const done = allProjs.reduce((a, b) => a + (b.hasPalletStage ? b.palletDone : b.packingDone), 0);
             const eff = total ? ((done/total)*100).toFixed(1) : 0;
             
             // UPDATE STATIC ELEMENTS instead of overwriting innerHTML
             document.getElementById('header-total-output').textContent = done.toLocaleString();
             document.getElementById('header-total-target').textContent = ' / ' + total.toLocaleString();
             document.getElementById('header-efficiency').textContent = eff + '%';
        }
        
        window.setFilter = (val) => { currentFilter = val; renderApp(); };

        function renderDetails(p) {
            const container = document.getElementById('assembly-details-container');
            container.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-white">${p.name}</h2>
                        <div class="flex gap-2 mt-1">
                            <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300">Target: ${p.totalQuantity}</span>
                            ${p.isUrgent ? '<span class="text-xs bg-red-900 text-red-200 px-2 py-1 rounded font-bold">URGENT</span>' : ''}
                        </div>
                        <div id="countdown-timer" class="text-sm mt-2 font-mono text-yellow-400"></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModalInternal()" class="p-2 bg-indigo-600 rounded hover:bg-indigo-500 text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                        <button onclick="window.openDeleteConfirm()" class="p-2 bg-red-600 rounded hover:bg-red-500 text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                </div>
            `;
            
            if(countdownInterval) clearInterval(countdownInterval);
            if(p.isUrgent && p.targetDate) {
                 const target = new Date(`${p.targetDate}T${p.targetTime || '00:00'}`);
                 const timerEl = document.getElementById('countdown-timer');
                 
                 const updateTimer = () => {
                     const diff = target - new Date();
                     if (diff <= 0) {
                         timerEl.innerHTML = "OVERDUE!";
                         timerEl.className = "text-sm mt-2 font-bold text-red-500 blinking-urgent";
                         return;
                     }
                     const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                     const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
                     const m = Math.floor((diff / 1000 / 60) % 60);
                     timerEl.innerHTML = `Due in: ${d}d ${h}h ${m}m`;
                 };
                 updateTimer();
                 countdownInterval = setInterval(updateTimer, 60000);
            }
        }

        function renderChart(p) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const labels = ['Assemble', 'QC', p.hasPalletStage ? 'Wrapping' : 'Packing'];
            const data = [p.rakitDone, p.qcDone, p.packingDone];
            const colors = ['#3b82f6', '#10b981', '#f97316'];
            
            if(p.hasPalletStage) {
                labels.push('Palletizing');
                data.push(p.palletDone); 
                colors.push('#8b5cf6');
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Units Completed',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 5,
                        datalabels: {
                            color: 'white', anchor: 'end', align: 'top',
                            formatter: (val, ctx) => {
                                if(p.hasPalletStage && ctx.dataIndex === 3) return Math.ceil(val/2) + ' Plt';
                                return val;
                            }
                        }
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: p.totalQuantity, grid: {color: '#374151'} }, x: { grid: {display: false} } },
                    plugins: { legend: {display: false} }
                }
            });
        }

        function renderCards(p) {
            const createCard = (id, name, val, color, icon) => {
                const isPallet = id === 'pallet';
                const displayVal = isPallet ? Math.ceil(val/2) : val;
                const displayMax = isPallet ? Math.ceil(p.totalQuantity/2) : p.totalQuantity;
                const unit = isPallet ? 'Plt' : 'Unit';
                
                const btnDec = isPallet ? `onclick="handlePalletAction(false)"` : `onclick="updateProgress('${id}', -1)"`;
                const btnInc = isPallet ? `onclick="handlePalletAction(true)"` : `onclick="updateProgress('${id}', 1)"`;
                const openManual = isPallet ? `openManualPallet()` : `openManual('${id}', '${name}')`;

                // Calculate Fill Percentage for the Shadow
                const fillPercent = Math.min((val / p.totalQuantity) * 100, 100);

                return `
                <div class="progress-card bg-gray-700 p-4 rounded-xl border-t-4 border-${color}-500 flex flex-col justify-between h-32 relative group overflow-hidden">
                    
                    <div class="absolute bottom-0 left-0 h-full bg-${color}-500 opacity-20 progress-fill pointer-events-none" style="width: ${fillPercent}%"></div>

                    <div class="relative z-10 flex justify-between items-start">
                        <h4 class="text-sm text-${color}-400 font-bold uppercase">${name}</h4>
                        <button onclick="${openManual}" class="text-gray-500 hover:text-white opacity-0 group-hover:opacity-100 transition"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                    </div>
                    <div class="relative z-10 text-center my-1">
                        <span class="text-3xl font-bold text-white">${displayVal}</span>
                        <span class="text-xs text-gray-400">/ ${displayMax} ${unit}</span>
                    </div>
                    <div class="relative z-10 flex justify-center gap-4 mt-auto">
                        <button ${btnDec} class="w-8 h-8 rounded-full bg-gray-800 hover:bg-red-500 border border-gray-600 text-white flex items-center justify-center transition shadow">-</button>
                        <button ${btnInc} class="w-8 h-8 rounded-full bg-${color}-600 hover:bg-${color}-500 text-white flex items-center justify-center transition shadow">+</button>
                    </div>
                </div>`;
            };

            let html = '';
            html += createCard('rakit', 'Assemble', p.rakitDone, 'blue');
            html += createCard('qc', 'Quality Ctrl', p.qcDone, 'green');
            html += createCard('packing', p.hasPalletStage ? 'Wrapping' : 'Packing', p.packingDone, 'orange');
            if(p.hasPalletStage) html += createCard('pallet', 'Palletizing', p.palletDone, 'purple');
            
            document.getElementById('progress-cards').innerHTML = html;
        }
        
        function renderHistory() {
            const list = document.getElementById('global-history-container');
            list.innerHTML = `
                <h3 class="text-sm font-bold text-gray-400 mb-2 uppercase tracking-wide">Recent Activity</h3>
                <div class="bg-gray-800 rounded-lg p-2 max-h-40 overflow-y-auto space-y-2 text-xs text-gray-300">
                    ${globalHistory.map(h => {
                        let c = 'text-gray-400';
                        if(h.type === 'CREATE') c = 'text-green-400';
                        if(h.type === 'DELETE') c = 'text-red-400';
                        if(h.type === 'PROGRESS') c = 'text-blue-400';
                        const time = new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        return `<div class="border-b border-gray-700 pb-1 last:border-0 flex justify-between"><span><b class="${c}">${h.type}</b>: ${h.message}</span> <span class="opacity-50">${time}</span></div>`
                    }).join('')}
                    ${globalHistory.length === 0 ? '<div class="text-center opacity-50 py-2">No history yet</div>' : ''}
                </div>
            `;
        }

        // --- UTILS ---
        
        function getStatus(p) {
            const done = p.hasPalletStage ? p.palletDone : p.packingDone;
            if(p.rakitDone === 0) return { text: 'Not Started', color: 'gray', bg: 'bg-gray-700' };
            if(done === p.totalQuantity) return { text: 'Completed', color: 'green', bg: 'bg-green-900 text-green-200' };
            if((done/p.totalQuantity) > 0.8) return { text: 'Finishing', color: 'yellow', bg: 'bg-yellow-900 text-yellow-200' };
            return { text: 'In Progress', color: 'blue', bg: 'bg-blue-900 text-blue-200' };
        }

        // FIXED CLOCK FUNCTION
        function startLiveClock() {
            setInterval(() => {
                const clockElement = document.getElementById('live-clock');
                if (clockElement) {
                    const now = new Date();
                    const time = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
                    const date = now.toLocaleDateString('en-US', {weekday:'short', day:'numeric', month:'short'});
                    clockElement.textContent = `${date} • ${time}`;
                }
            }, 1000);
        }

        function showNotification(msg, type) {
            const box = document.getElementById('notification-box');
            box.textContent = msg;
            box.className = `fixed top-20 right-4 p-4 rounded-lg text-white shadow-xl z-50 transition-all duration-300 ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            setTimeout(() => { box.classList.add('opacity-0', 'pointer-events-none'); }, 3000);
        }

        function downloadDashboard() {
            html2canvas(document.body, {backgroundColor: '#111827'}).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Microvision-Dashboard.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
        
        // --- MODAL HELPERS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none');
        window.closeModal = (id) => document.getElementById(id).classList.add('opacity-0', 'pointer-events-none');
        
        window.selectProject = (id) => { currentProjectId = id; renderApp(); };
        window.window.openDeleteConfirm = () => window.openModal('deleteConfirmModal');
        
        // Edit Modal Wiring
        window.openEditModalInternal = () => {
            const p = projects.find(x => x.id === currentProjectId);
            document.getElementById('editProjectName').value = p.name;
            document.getElementById('editProjectQuantity').value = p.totalQuantity;
            document.getElementById('editProjectHasPallet').checked = p.hasPalletStage;
            document.getElementById('editProjectUrgent').checked = p.isUrgent;
            document.getElementById('editProjectTargetDate').value = p.targetDate || '';
            document.getElementById('editProjectTargetTime').value = p.targetTime || '';
            window.openModal('editProjectModal');
        };

        window.handleEditSubmit = (e) => {
            e.preventDefault();
            const p = projects.find(x => x.id === currentProjectId);
            p.name = document.getElementById('editProjectName').value;
            p.totalQuantity = parseInt(document.getElementById('editProjectQuantity').value);
            p.hasPalletStage = document.getElementById('editProjectHasPallet').checked;
            p.isUrgent = document.getElementById('editProjectUrgent').checked;
            p.targetDate = document.getElementById('editProjectTargetDate').value;
            p.targetTime = document.getElementById('editProjectTargetTime').value;
            
            addHistoryLog('EDIT', `Updated details for "${p.name}"`);
            syncData();
            renderApp();
            closeModal('editProjectModal');
        };
        
        // Manual Inputs
        window.openManual = (stage, title) => {
            document.getElementById('manualInputModalTitle').textContent = `Update ${title}`;
            const p = projects.find(x => x.id === currentProjectId);
            const input = document.getElementById('manualProgressValue');
            input.value = p[`${stage}Done`];
            
            document.getElementById('manualInputForm').onsubmit = (e) => {
                e.preventDefault();
                const val = parseInt(input.value);
                const diff = val - p[`${stage}Done`];
                if(diff !== 0) updateProgress(stage, diff);
                closeModal('manualInputModal');
            };
            openModal('manualInputModal');
        };

        window.openManualPallet = () => {
             const p = projects.find(x => x.id === currentProjectId);
             const input = document.getElementById('manualPalletValue');
             input.value = Math.ceil(p.palletDone / 2); 
             
             document.getElementById('manualPalletForm').onsubmit = (e) => {
                 e.preventDefault();
                 const newPalletCount = parseInt(input.value);
                 const newItems = newPalletCount * 2;
                 const finalItems = Math.min(newItems, p.totalQuantity);
                 
                 const diff = finalItems - p.palletDone;
                 if(diff !== 0) updateProgress('pallet', diff);
                 closeModal('manualPalletInputModal');
             };
             openModal('manualPalletInputModal');
        };

        // START APP
        window.onload = initApp;

    </script>
</body>
</html>
